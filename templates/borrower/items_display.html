{% extends "base.html" %}

{% block title %}Available Items - Laboratory Borrowing System{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <h2>Available Items</h2>
  <p>Browse available laboratory items to borrow. Add items to your cart and proceed to complete your borrowing request.</p>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search for equipment..." oninput="searchItems()">
    <button class="btn" onclick="clearSearch()">Clear</button>
  </div>

  <!-- Equipment Categories and Items -->
  <div id="items-container">
    {% for category in categories %}
      <div class="category-section" data-category-id="{{ category.id }}">
        <h3 class="category-title">
          <span class="toggle-icon">▼</span>{{ category.name }}
        </h3>
        {% if items_by_category[category.id]|length > 0 %}
          <div class="items-grid">
            {% for item in items_by_category[category.id] %}
              <div class="item-card" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}">
                <!-- Item Image -->
                <div class="item-image-container">
                  <img id="img-{{ item.id }}" class="item-image"
                       src="{{ url_for('static', filename='img/' + item.category.lower() + '/' + item.image_basename + '.jpg') }}"
                       onerror="this.onerror=null; tryNextImageFormat(this, '{{ item.image_basename }}', '{{ item.category }}');"
                       alt="{{ item.name }}">
                </div>

                <div class="item-name">{{ item.name }}</div>

                {% if item.status == 'available' %}
                  <div class="item-status status-available">Available</div>
                {% elif item.status == 'unavailable' %}
                  <div class="item-status status-unavailable">Unavailable</div>
                {% else %}
                  <div class="item-status status-maintenance">Under Maintenance</div>
                {% endif %}

                <div class="item-quantity">
                  Available: <strong>{{ item.available_quantity }}</strong> / Total: {{ item.total_quantity }}
                </div>

                <div class="item-actions">
                  <div class="quantity-selector">
                    <button onclick="decrementQuantity('{{ item.id }}')">-</button>
                    <input type="number" id="quantity-{{ item.id }}" min="1" max="{{ item.available_quantity }}" value="1" readonly>
                    <button onclick="incrementQuantity('{{ item.id }}', {{ item.available_quantity }})">+</button>
                  </div>
                  
                  <button class="add-to-cart" 
                          onclick="addToCart('{{ item.id }}', '{{ item.name }}', {{ item.available_quantity }})"
                          {% if item.status != 'available' or item.available_quantity < 1 %}disabled{% endif %}>
                    Add to Cart
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="no-items-message">No items available in this category</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Borrowing Cart -->
  <div class="cart-preview" id="borrowing-cart">
    <div class="cart-header">
      <div class="cart-title">Borrowing Cart (<span id="cart-count">0</span>)</div>
      <button class="cart-toggle" id="toggle-cart">▲</button>
    </div>
    
    <div id="cart-content">
      <div class="cart-items" id="cart-items-container">
        <p class="no-items-message">Your cart is empty</p>
      </div>
      
      <div class="cart-actions">
        <button class="empty-cart" onclick="emptyCart()">Empty Cart</button>
        <button class="proceed-button" onclick="proceedToBorrow()" id="proceed-button" disabled>Proceed</button>
      </div>
    </div>
  </div>

  <div class="logout-container">
    <a href="{{ url_for('borrower_dashboard') }}" class="btn">Back to Dashboard</a>
  </div>
</div>

<!-- templates/borrow_modal.html -->
<div id="borrower-form-modal" class="modal">
  <div class="modal-content">
    <div class="form-preview-container">
      <form id="borrower-form">
        <div class="form-header">
          <div class="form-id">F-COL-004<br>06-15-2013</div>
          <h1>JOSÉ RIZAL UNIVERSITY</h1>
          <h2>COLLEGE LABORATORY BORROWER'S FORM</h2>
        </div>
        
        <!-- Updated Laboratory section to be one continuous line -->
        <div class="form-section">
          <div class="laboratory-section">
            <span class="lab-label">LABORATORY:</span>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <label class="checkbox-container">
                  <input type="radio" name="laboratory" value="Electronics" required>
                  <span id="lab-electronics" class="checkbox-box"></span>
                  <span class="checkbox-label">Electronics</span>
                </label>
              </div>
              <div class="checkbox-item">
                <label class="checkbox-container">
                  <input type="radio" name="laboratory" value="Science" required>
                  <span id="lab-science" class="checkbox-box"></span>
                  <span class="checkbox-label">Science</span>
                </label>
              </div>
              <div class="checkbox-item">
                <label class="checkbox-container">
                  <input type="radio" name="laboratory" value="Nursing" required>
                  <span id="lab-nursing" class="checkbox-box"></span>
                  <span class="checkbox-label">Nursing</span>
                </label>
              </div>
              <div class="checkbox-item">
                <label class="checkbox-container">
                  <input type="radio" name="laboratory" value="HTM" required>
                  <span id="lab-htm" class="checkbox-box"></span>
                  <span class="checkbox-label">HTM</span>
                </label>
              </div>
              <div class="checkbox-item">
                <label class="checkbox-container">
                  <input type="radio" name="laboratory" value="Criminology" required>
                  <span id="lab-criminology" class="checkbox-box"></span>
                  <span class="checkbox-label">Criminology</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Updated form fields to show labels inline with inputs -->
        <div class="form-section">
          <div class="form-row">
            <div class="form-field">
              <label for="borrower_name">NAME OF STUDENT/FACULTY:</label>
              <div class="split-field">
                <input type="text" id="student_name" name="student_name" class="value-input" placeholder="Student Name" required>
                <span class="field-separator">/</span>
                <input type="text" id="faculty_name" name="faculty_name" class="value-input" placeholder="Faculty Name">
              </div>
            </div>
            <div class="form-field">
              <label for="date_filed">DATE FILED:</label>
              <input type="date" id="date_filed" name="date_filed" class="value-input" readonly required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-field">
              <label for="subject_section">SUBJECT/SECTION:</label>
              <div class="split-field">
                <input type="text" id="subject" name="subject" class="value-input" placeholder="Subject" required>
                <span class="field-separator">/</span>
                <input type="text" id="section" name="section" class="value-input" placeholder="Section" required>
              </div>
            </div>
            <div class="form-field">
              <label for="date_needed">DATE/TIME NEEDED:</label>
              <input type="datetime-local" id="date_needed" name="date_needed" class="value-input" required>
            </div>
          </div>
        </div>
      
        <div class="form-section">
          <table class="items-table">
            <thead>
              <tr>
                <th rowspan="3" style="width: 200px;">ITEM</th>
                <th colspan="4">RELEASED</th>
                <th colspan="7">RETURNED</th>
              </tr>
              <tr>
                <th rowspan="2" style="width: 50px;">QUANTITY</th>
                <th colspan="3">SIGNATURE</th>
                <th rowspan="2" style="width: 80px;">DATE</th>
                <th rowspan="2" style="width: 80px;">TIME</th>
                <th colspan="3"></th>
                <th rowspan="2">REMARKS</th>
              </tr>
              <tr>
                <th style="width: 100px;">STUDENT</th>
                <th style="width: 100px;">FACULTY</th>
                <th style="width: 100px;">CUSTODIAN</th>
                <th style="width: 90px;">BROKEN</th>
                <th style="width: 90px;">LOST</th>
                <th style="width: 90px;">QUANTITY</th>
              </tr>
            </thead>
            <tbody id="items-table-body">
              <!-- Items will be populated here dynamically -->
            </tbody>
          </table>
        </div>
        
        <div class="action-buttons">
          <button type="button" class="btn btn-danger" id="cancel-form">Cancel</button>
          <button type="button" class="btn btn-primary" id="submit-form">Submit Request</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal-body">
  <!-- File upload field -->
  <div class="mb-3">
    <label for="signature-upload" class="form-label">Upload Signature:</label>
    <input type="file" id="signature-upload" accept="image/*" class="form-control">
  </div>

  <!-- Table container (position-relative for overlay) -->
  <div id="items-table-container" class="position-relative">
    <!-- Existing items table -->
    <table id="items-table" class="table table-bordered">
      <!-- ... table rows here ... -->
    </table>

    <!-- Signature overlay (hidden until an image is loaded) -->
    <div id="signature-overlay" class="signature-overlay" style="display:none;">
      <img id="signature-image" src="" alt="Signature Preview">
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{% endblock %}
